{
    "$schema": "http://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
    "contentVersion": "1.0.0.0",
    "parameters": {
        "cognitiveServicesResourceName": {
            "type": "String"
        },
        "cognitiveServicesResourceRegion": {
            "defaultValue": "westus",
            "type": "String",
            "allowedValues": [
                "centralus",
                "eastus",
                "eastus2",
                "northcentralus",
                "southcentralus",
                "westcentralus",
                "westus",
                "westus2",
                "canadacentral",
                "brazilsouth",
                "eastasia",
                "southeastasia",
                "australiaeast",
                "centralindia",
                "japaneast",
                "japanwest",
                "koreacentral",
                "northeurope",
                "westeurope",
                "francecentral",
                "uksouth"
            ],
            "metadata": {
                "description": "The default cognitive services resource region."
            }
        },
        "customModelId": {
            "defaultValue": "",
            "type": "String"
        },
        "cognitiveServicesFallbackResourceName": {
            "type": "String"
        },
        "cognitiveServicesFallbackResourceRegion": {
            "defaultValue": "westcentralus",
            "type": "String",
            "allowedValues": [
                "centralus",
                "eastus",
                "eastus2",
                "northcentralus",
                "southcentralus",
                "westcentralus",
                "westus",
                "westus2",
                "canadacentral",
                "brazilsouth",
                "eastasia",
                "southeastasia",
                "australiaeast",
                "centralindia",
                "japaneast",
                "japanwest",
                "koreacentral",
                "northeurope",
                "westeurope",
                "francecentral",
                "uksouth"
            ],
            "metadata": {
                "description": "The fallback cognitive services resource region."
            }
        },
        "fallbackCustomModelId": {
            "defaultValue": "",
            "type": "String"
        },
        "transcriptionLocale": {
            "defaultValue": "en-US | English (United States)",
            "type": "String",
            "allowedValues": [
                "ar-BH | Arabic (Bahrain)",
                "ar-EG | Arabic (Egypt)",
                "ar-SY | Arabic (Syria)",
                "ca-ES | Catalan",
                "da-DK | Danish (Denmark)",
                "de-DE | German (Germany)",
                "en-AU | English (Australia)",
                "en-CA | English (Canada)",
                "en-GB | English (United Kingdom)",
                "en-IN | English (India)",
                "en-NZ | English (New Zealand)",
                "en-US | English (United States)",
                "es-ES | Spanish (Spain)",
                "es-MX | Spanish (Mexico)",
                "fi-FI | Finnish (Finland)",
                "fr-CA | French (Canada)",
                "fr-FR | French (France)",
                "gu-IN | Gujarati (Indian)",
                "hi-IN | Hindi (India)",
                "it-IT | Italian (Italy)",
                "ja-JP | Japanese (Japan)",
                "ko-KR | Korean (Korea)",
                "mr-IN | Marathi (India)",
                "nb-NO | Norwegian (Bokm√•l)",
                "nl-NL | Dutch (Netherlands)",
                "pl-PL | Polish (Poland)",
                "pt-BR | Portuguese (Brazil)",
                "pt-PT | Portuguese (Portugal)",
                "ru-RU | Russian (Russia)",
                "sv-SE | Swedish (Sweden)",
                "ta-IN | Tamil (India)",
                "te-IN | Telugu (India)",
                "th-TH | Thai (Thailand)",
                "tr-TR | Turkish (Turkey)",
                "zh-CN | Chinese (Mandarin, simplified)",
                "zh-HK | Chinese (Cantonese, Traditional)",
                "zh-TW | Chinese (Taiwanese Mandarin)"
            ]
        },
        "ProfanityFilterMode": {
            "defaultValue": "None",
            "type": "String",
            "allowedValues": [
                "None",
                "Removed",
                "Tags",
                "Masked"
            ],
            "metadata": {
                "description": "The requested profanity filter mode."
            }
        },
        "PunctuationMode": {
            "defaultValue": "DictatedAndAutomatic",
            "type": "String",
            "allowedValues": [
                "None",
                "Dictated",
                "Automatic",
                "DictatedAndAutomatic"
            ],
            "metadata": {
                "description": "The requested punctuation mode."
            }
        },
        "AddDiarization": {
            "defaultValue": false,
            "type": "bool",
            "metadata": {
                "description": "A value indicating whether diarization (speaker separation) is requested."
            }
        },
        "AddWordLevelTimestamps": {
            "defaultValue": false,
            "type": "bool",
            "metadata": {
                "description": "A value indicating whether word level timestamps are requested."
            }
        },
        "storageResourceName": {
            "type": "String"
        },
        "storageResourceRegion": {
            "defaultValue": "eastus",
            "type": "String",
            "allowedValues": [
                "centralus",
                "eastus",
                "eastus2",
                "northcentralus",
                "southcentralus",
                "westcentralus",
                "westus",
                "westus2",
                "canadacentral",
                "brazilsouth",
                "eastasia",
                "southeastasia",
                "australiaeast",
                "centralindia",
                "japaneast",
                "japanwest",
                "koreacentral",
                "northeurope",
                "westeurope",
                "francecentral",
                "uksouth"
            ],
            "metadata": {
                "description": "The fallback cognitive services resource region."
            }
        },
        "DeploymentId": {
            "type": "string",
            "defaultValue": "[utcNow()]",
            "metadata": {
                "description": "Id that will be suffixed to all created resources to identify resources of a certain deployment. Leave as is to use timestamp as deployment id."
            }
        }
    },
    "variables": {
        "sku": "S0",
        "tagValues": {},
        "storageSkuType": "Standard_LRS",
        "storageKind": "StorageV2",
        "builtInRoleType": "Contributor",
        "virtualNetworkType": "None",
        "vnet": {},
        "ipRules": [],
        "roleAssignmentGuid": "[guid(resourceGroup().id, deployment().name, 'primary')]",
        "fallbackRoleAssignmentGuid": "[guid(resourceGroup().id, deployment().name, 'fallback')]",
        "StorageAccountContributorGuid": "ba92f5b4-2d11-453d-a403-e96b0029c9fe",
        "Contributor": "[concat('/subscriptions/', subscription().subscriptionId, '/providers/Microsoft.Authorization/roleDefinitions/', variables('StorageAccountContributorGuid'))]",
        "vnetProperties": {
            "publicNetworkAccess": "[if(equals(variables('virtualNetworkType'), 'Internal'), 'Disabled', 'Enabled')]",
            "networkAcls": {
                "defaultAction": "[if(equals(variables('virtualNetworkType'), 'External'), 'Deny', 'Allow')]",
                "virtualNetworkRules": "[if(equals(variables('virtualNetworkType'), 'External'), json(concat('[{\"id\": \"', concat(subscription().id, '/resourceGroups/', variables('vnet').resourceGroup, '/providers/Microsoft.Network/virtualNetworks/', variables('vnet').name, '/subnets/', variables('vnet').subnets.subnet.name), '\"}]')), json('[]'))]",
                "ipRules": "[if(or(empty(variables('ipRules')), empty(variables('ipRules')[0].value)), json('[]'), variables('ipRules'))]"
            }
        },
        "vnetPropertiesByos": {
            "publicNetworkAccess": "[if(equals(variables('virtualNetworkType'), 'Internal'), 'Disabled', 'Enabled')]",
            "networkAcls": {
                "defaultAction": "[if(equals(variables('virtualNetworkType'), 'External'), 'Deny', 'Allow')]",
                "virtualNetworkRules": "[if(equals(variables('virtualNetworkType'), 'External'), json(concat('[{\"id\": \"', concat(subscription().id, '/resourceGroups/', variables('vnet').resourceGroup, '/providers/Microsoft.Network/virtualNetworks/', variables('vnet').name, '/subnets/', variables('vnet').subnets.subnet.name), '\"}]')), json('[]'))]",
                "ipRules": "[if(or(empty(variables('ipRules')), empty(variables('ipRules')[0].value)), json('[]'), variables('ipRules'))]"
            },
            "userOwnedStorage": "[if(not(empty(parameters('storageResourceName'))), createArray(json(concat('{\"resourceId\": \"',concat(subscription().id,'/resourcegroups/', resourceGroup().name, '/providers/Microsoft.Storage/storageAccounts/', parameters('storageResourceName'), '\"}')))), json('[]'))]"
        },
        "DeploymentId": "[parameters('DeploymentId')]",
        "AppInsightsName": "[concat('AppInsights-', variables('DeploymentId'))]",
        "ServiceBusName": "[concat('ServiceBus-', variables('DeploymentId'))]",
        "IngestionClientRegion": "[resourceGroup().location]",
        "AppServicePlanName": "[concat('AppServicePlan-', variables('DeploymentId'))]",
        "KeyVaultName": "[concat('KV-', variables('DeploymentId'))]",
        "CognitiveServicesKeySecretName": "CognitiveServicesKey",
        "CognitiveServicesFallbackKeySecretName": "CognitiveServicesFallbackKey",
        "AudioInputContainer": "audio-input",
        "AudioProcessedContainer": "audio-processed",
        "AudioFailedContainer": "audio-failed",
        "JsonResultOutputContainer": "json-result-output",
        "ErrorReportOutputContainer": "error-report",
        "SpeechServicesOutputContainer": "customspeech-artifacts",
        "EventGridSystemTopicName": "[concat('EventGrid-', variables('DeploymentId'))]",
        "AudioUploadedQueueName": "audio_uploaded_queue",
        "AudioUploadedEventName": "AudioUploaded",
        "ResultUploadedQueueName": "result_uploaded_queue",
        "ResultUploadedEventName": "ResultUploaded",
        "IngestionClientAudioUploadedFunctionName": "[take(concat('IngestionClientAudioUpload-', variables('DeploymentId')),60)]",
        "IngestionClientAudioUploadedFunctionId": "[resourceId('Microsoft.Web/sites', variables('IngestionClientAudioUploadedFunctionName'))]",
        "AuthRuleAudioUploaded": "[resourceId('Microsoft.ServiceBus/namespaces/queues/authorizationRules', variables('ServiceBusName'), variables('AudioUploadedQueueName'), variables('AudioUploadedEventName'))]",
        "IngestionClientResultUploadedFunctionName": "[take(concat('IngestionClientResultUpload-', variables('DeploymentId')),60)]",
        "IngestionClientResultUploadedFunctionId": "[resourceId('Microsoft.Web/sites', variables('IngestionClientResultUploadedFunctionName'))]",
        "AuthRuleResultUploaded": "[resourceId('Microsoft.ServiceBus/namespaces/queues/authorizationRules', variables('ServiceBusName'), variables('ResultUploadedQueueName'), variables('ResultUploadedEventName'))]",
        "AuthRuleRMK": "[resourceId('Microsoft.ServiceBus/namespaces/authorizationRules', variables('ServiceBusName'),'RootManageSharedAccessKey')]",
        "DeleteProcessedAudioFilesFromStorage": false,
        "DeleteCustomSpeechArtifacts": true,
        "TranscriptionTimeToLive": "P1D",
        "MessagesPerFunctionExecution": 1000,
        "FilesPerTranscriptionJob": 100,
        "RetryLimit": 4,
        "InitialRetryDelayInMinutes": 2,
        "MaxRetryDelayInMinutes": 16,
        "AudioUploadedFunctionBinary": "https://mspublicstorage.blob.core.windows.net/ingestion-client-byos/ByosAudioUploaded.zip",
        "ResultUploadedFunctionBinary": "https://mspublicstorage.blob.core.windows.net/ingestion-client-byos/ByosResultUploaded.zip"
    },
    "resources": [
        {
            "type": "Microsoft.Storage/storageAccounts",
            "apiVersion": "2019-06-01",
            "name": "[parameters('storageResourceName')]",
            "location": "[parameters('storageResourceRegion')]",
            "sku": {
                "name": "[variables('storageSkuType')]"
            },
            "kind": "[variables('storageKind')]",
            "properties": {},
            "resources": [
                {
                    "type": "Microsoft.Storage/storageAccounts/blobServices",
                    "apiVersion": "2019-06-01",
                    "location": "[parameters('storageResourceRegion')]",
                    "name": "[concat(parameters('storageResourceName'), '/default')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]"
                    ],
                    "sku": {
                        "name": "[variables('storageSkuType')]"
                    },
                    "properties": {
                        "cors": {
                            "corsRules": []
                        },
                        "deleteRetentionPolicy": {
                            "enabled": false
                        }
                    }
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                    "apiVersion": "2019-06-01",
                    "name": "[concat(parameters('storageResourceName'), '/default/', variables('AudioInputContainer'))]",
                    "location": "[parameters('storageResourceRegion')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageResourceName'), 'default')]",
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]"
                    ],
                    "properties": {
                        "publicAccess": "None"
                    }
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                    "apiVersion": "2019-06-01",
                    "name": "[concat(parameters('storageResourceName'), '/default/', variables('AudioProcessedContainer'))]",
                    "location": "[parameters('storageResourceRegion')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageResourceName'), 'default')]",
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]"
                    ],
                    "properties": {
                        "publicAccess": "None"
                    }
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                    "apiVersion": "2019-06-01",
                    "name": "[concat(parameters('storageResourceName'), '/default/', variables('AudioFailedContainer'))]",
                    "location": "[parameters('storageResourceRegion')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageResourceName'), 'default')]",
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]"
                    ],
                    "properties": {
                        "publicAccess": "None"
                    }
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                    "apiVersion": "2019-06-01",
                    "name": "[concat(parameters('storageResourceName'), '/default/', variables('JsonResultOutputContainer'))]",
                    "location": "[parameters('storageResourceRegion')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageResourceName'), 'default')]",
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]"
                    ],
                    "properties": {
                        "publicAccess": "None"
                    }
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                    "apiVersion": "2019-06-01",
                    "name": "[concat(parameters('storageResourceName'), '/default/', variables('ErrorReportOutputContainer'))]",
                    "location": "[parameters('storageResourceRegion')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageResourceName'), 'default')]",
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]"
                    ],
                    "properties": {
                        "publicAccess": "None"
                    }
                },
                {
                    "type": "Microsoft.Storage/storageAccounts/blobServices/containers",
                    "apiVersion": "2019-06-01",
                    "name": "[concat(parameters('storageResourceName'), '/default/', variables('SpeechServicesOutputContainer'))]",
                    "location": "[parameters('storageResourceRegion')]",
                    "dependsOn": [
                        "[resourceId('Microsoft.Storage/storageAccounts/blobServices', parameters('storageResourceName'), 'default')]",
                        "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]"
                    ],
                    "properties": {
                        "publicAccess": "None"
                    }
                }
            ]
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "grantMIAccessToStorage",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Storage/storageAccounts/providers/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "name": "[concat(parameters('storageResourceName'), '/Microsoft.Authorization/', variables('roleAssignmentGuid'))]",
                            "properties": {
                                "roleDefinitionId": "[variables(variables('builtInRoleType'))]",
                                "principalId": "[reference(concat('Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesResourceName')), '2017-04-18', 'Full').identity.principalId]",
                                "principalType": "ServicePrincipal",
                                "scope": "[concat(subscription().id,'/resourcegroups/', resourceGroup().name, '/providers/Microsoft.Storage/storageAccounts/', parameters('storageResourceName'))]"
                            }
                        },
                        {
                            "type": "Microsoft.Storage/storageAccounts/providers/roleAssignments",
                            "apiVersion": "2018-09-01-preview",
                            "name": "[concat(parameters('storageResourceName'), '/Microsoft.Authorization/', variables('fallbackRoleAssignmentGuid'))]",
                            "properties": {
                                "roleDefinitionId": "[variables(variables('builtInRoleType'))]",
                                "principalId": "[reference(concat('Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesFallbackResourceName')), '2017-04-18', 'Full').identity.principalId]",
                                "principalType": "ServicePrincipal",
                                "scope": "[concat(subscription().id,'/resourcegroups/', resourceGroup().name, '/providers/Microsoft.Storage/storageAccounts/', parameters('storageResourceName'))]"
                            }
                        }
                    ]
                },
                "parameters": {}
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "attachStorageAccount",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'grantMIAccessToStorage')]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.CognitiveServices/accounts",
                            "apiVersion": "2017-04-18",
                            "name": "[parameters('cognitiveServicesResourceName')]",
                            "location": "[parameters('cognitiveServicesResourceRegion')]",
                            "sku": {
                                "name": "[variables('sku')]"
                            },
                            "kind": "SpeechServices",
                            "tags": "[if(contains(variables('tagValues'), 'Microsoft.CognitiveServices/accounts'), variables('tagValues')['Microsoft.CognitiveServices/accounts'], json('{}'))]",
                            "identity": {
                                "tenantId": "[reference(concat('Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesResourceName')), '2017-04-18', 'Full').identity.tenantId]",
                                "principalId": "[reference(concat('Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesResourceName')), '2017-04-18', 'Full').identity.principalId]",
                                "type": "systemAssigned"
                            },
                            "properties": "[variables('vnetPropertiesByos')]"
                        },
                        {
                            "type": "Microsoft.CognitiveServices/accounts",
                            "apiVersion": "2017-04-18",
                            "name": "[parameters('cognitiveServicesFallbackResourceName')]",
                            "location": "[parameters('cognitiveServicesFallbackResourceRegion')]",
                            "sku": {
                                "name": "[variables('sku')]"
                            },
                            "kind": "SpeechServices",
                            "tags": "[if(contains(variables('tagValues'), 'Microsoft.CognitiveServices/accounts'), variables('tagValues')['Microsoft.CognitiveServices/accounts'], json('{}'))]",
                            "identity": {
                                "tenantId": "[reference(concat('Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesFallbackResourceName')), '2017-04-18', 'Full').identity.tenantId]",
                                "principalId": "[reference(concat('Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesFallbackResourceName')), '2017-04-18', 'Full').identity.principalId]",
                                "type": "systemAssigned"
                            },
                            "properties": "[variables('vnetPropertiesByos')]"
                        }
                    ]
                },
                "parameters": {}
            }
        },
        {
            "type": "Microsoft.Resources/deployments",
            "apiVersion": "2017-05-10",
            "name": "test",
            "dependsOn": [
                "[concat('Microsoft.Resources/deployments/', 'attachStorageAccount')]",
                "[resourceId('Microsoft.Insights/components', variables('AppInsightsName'))]",
                "[concat('Microsoft.Web/sites/', variables('IngestionClientAudioUploadedFunctionName'))]",
                "[concat('Microsoft.Web/sites/', variables('IngestionClientResultUploadedFunctionName'))]",
                "[resourceId('Microsoft.KeyVault/vaults', variables('KeyVaultName'))]",
                "[resourceId('Microsoft.KeyVault/vaults/secrets', variables('KeyVaultName'), variables('CognitiveServicesKeySecretName'))]",
                "[resourceId('Microsoft.KeyVault/vaults/secrets', variables('KeyVaultName'), variables('CognitiveServicesFallbackKeySecretName'))]",
                "[variables('AuthRuleRMK')]",
                "[variables('AuthRuleAudioUploaded')]"
            ],
            "properties": {
                "mode": "Incremental",
                "template": {
                    "$schema": "https://schema.management.azure.com/schemas/2015-01-01/deploymentTemplate.json#",
                    "contentVersion": "1.0.0.0",
                    "parameters": {},
                    "variables": {},
                    "resources": [
                        {
                            "type": "Microsoft.Web/sites/config",
                            "name": "[concat(variables('IngestionClientAudioUploadedFunctionName'), '/AppSettings')]",
                            "apiVersion": "2020-09-01",
                            "location": "[variables('IngestionClientRegion')]",
                            "tags": {
                               "displayName": "WebAppSettings"
                            },
                            "properties": {
                                "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference(resourceId('Microsoft.Insights/components', variables('AppInsightsName')), '2020-02-02-preview').ConnectionString]",
                                "FUNCTIONS_EXTENSION_VERSION": "~3",
                                "FUNCTIONS_WORKER_RUNTIME": "dotnet",
                                "WEBSITE_RUN_FROM_PACKAGE": "[variables('AudioUploadedFunctionBinary')]",
                                "AzureServiceBus": "[listKeys(variables('AuthRuleRMK'),'2015-08-01').primaryConnectionString]",
                                "AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageResourceName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value, ';EndpointSuffix=core.windows.net')]",
                                "AzureWebJobsDashboard": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageResourceName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value, ';EndpointSuffix=core.windows.net')]",
                                "CognitiveServicesKey": "[concat('@Microsoft.KeyVault(VaultName=', variables('KeyVaultName'), ';SecretName=', variables('CognitiveServicesKeySecretName'), ')')]",
                                "CognitiveServicesRegion": "[parameters('cognitiveServicesResourceRegion')]",
                                "CustomModelId": "[parameters('customModelId')]",
                                "CognitiveServicesFallbackKey": "[concat('@Microsoft.KeyVault(VaultName=', variables('KeyVaultName'), ';SecretName=', variables('CognitiveServicesFallbackKeySecretName'), ')')]",
                                "CognitiveServicesFallbackRegion": "[parameters('cognitiveServicesFallbackResourceRegion')]",
                                "FallbackCustomModelId": "[parameters('fallbackCustomModelId')]",
                                "AddDiarization": "[parameters('AddDiarization')]",
                                "AddWordLevelTimestamps": "[parameters('AddWordLevelTimestamps')]",
                                "DeleteProcessedAudioFilesFromStorage": "[variables('DeleteProcessedAudioFilesFromStorage')]",
                                "ProfanityFilterMode": "[parameters('ProfanityFilterMode')]",
                                "PunctuationMode": "[parameters('PunctuationMode')]",
                                "TranscriptionTimeToLive": "[variables('TranscriptionTimeToLive')]",
                                "AudioInputContainer": "[variables('AudioInputContainer')]",
                                "AudioFailedContainer": "[variables('AudioFailedContainer')]",
                                "ErrorReportOutputContainer": "[variables('ErrorReportOutputContainer')]",
                                "FilesPerTranscriptionJob": "[variables('FilesPerTranscriptionJob')]",
                                "InitialRetryDelayInMinutes": "[variables('InitialRetryDelayInMinutes')]",
                                "MaxRetryDelayInMinutes": "[variables('MaxRetryDelayInMinutes')]",
                                "MessagesPerFunctionExecution": "[variables('MessagesPerFunctionExecution')]",
                                "Locale": "[parameters('transcriptionLocale')]",
                                "RetryLimit": "[variables('RetryLimit')]",
                                "AudioUploadedServiceBusConnectionString": "[listKeys(variables('AuthRuleAudioUploaded'),'2015-08-01').primaryConnectionString]"
                            }
                        },
                        {
                            "type": "Microsoft.Web/sites/config",
                            "name": "[concat(variables('IngestionClientResultUploadedFunctionName'), '/AppSettings')]",
                            "apiVersion": "2020-09-01",
                            "location": "[resourceGroup().location]",
                            "tags": {
                                "displayName": "WebAppSettings"
                            },
                            "properties": {
                                "APPLICATIONINSIGHTS_CONNECTION_STRING": "[reference(resourceId('Microsoft.Insights/components', variables('AppInsightsName')), '2020-02-02-preview').ConnectionString]",
                                "FUNCTIONS_EXTENSION_VERSION": "~3",
                                "FUNCTIONS_WORKER_RUNTIME": "dotnet",
                                "WEBSITE_RUN_FROM_PACKAGE": "[variables('ResultUploadedFunctionBinary')]",
                                "AzureServiceBus": "[listKeys(variables('AuthRuleRMK'),'2015-08-01').primaryConnectionString]",
                                "AzureWebJobsStorage": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageResourceName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value, ';EndpointSuffix=core.windows.net')]",
                                "AzureWebJobsDashboard": "[concat('DefaultEndpointsProtocol=https;AccountName=', parameters('storageResourceName'), ';AccountKey=', listKeys(resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName')), providers('Microsoft.Storage', 'storageAccounts').apiVersions[0]).keys[0].value, ';EndpointSuffix=core.windows.net')]",
                                "AudioInputContainer": "[variables('AudioInputContainer')]",
                                "AudioFailedContainer": "[variables('AudioFailedContainer')]",
                                "AudioProcessedContainer": "[variables('AudioProcessedContainer')]",
                                "DeleteProcessedAudioFilesFromStorage": "[variables('DeleteProcessedAudioFilesFromStorage')]",
                                "DeleteCustomSpeechArtifacts": "[variables('DeleteCustomSpeechArtifacts')]",
                                "ErrorReportOutputContainer": "[variables('ErrorReportOutputContainer')]",
                                "JsonResultOutputContainer": "[variables('JsonResultOutputContainer')]",
                                "SpeechServicesOutputContainer": "[variables('SpeechServicesOutputContainer')]", 
                                "AudioUploadedServiceBusConnectionString": "[listKeys(variables('AuthRuleAudioUploaded'),'2015-08-01').primaryConnectionString]"
                            }
                        }
                    ]
                }
            },
            "resourceGroup": "[resourceGroup().name]"
        },
        {
            "type": "Microsoft.CognitiveServices/accounts",
            "apiVersion": "2017-04-18",
            "name": "[parameters('cognitiveServicesResourceName')]",
            "location": "[parameters('cognitiveServicesResourceRegion')]",
            "tags": "[if(contains(variables('tagValues'), 'Microsoft.CognitiveServices/accounts'), variables('tagValues')['Microsoft.CognitiveServices/accounts'], json('{}'))]",
            "sku": {
                "name": "[variables('sku')]"
            },
            "kind": "SpeechServices",
            "identity": {
                "type": "systemAssigned"
            },
            "properties": "[variables('vnetProperties')]"
        },
        {
            "type": "Microsoft.CognitiveServices/accounts",
            "apiVersion": "2017-04-18",
            "name": "[parameters('cognitiveServicesFallbackResourceName')]",
            "location": "[parameters('cognitiveServicesFallbackResourceRegion')]",
            "tags": "[if(contains(variables('tagValues'), 'Microsoft.CognitiveServices/accounts'), variables('tagValues')['Microsoft.CognitiveServices/accounts'], json('{}'))]",
            "sku": {
                "name": "[variables('sku')]"
            },
            "kind": "SpeechServices",
            "identity": {
                "type": "systemAssigned"
            },
            "properties": "[variables('vnetProperties')]"
        },
        {
            "type": "Microsoft.Insights/components",
            "apiVersion": "2020-02-02-preview",
            "name": "[variables('AppInsightsName')]",
            "location": "[variables('IngestionClientRegion')]",
            "tags": {
                "applicationType": "web",
                "applicationName": "TranscriptionInsights"
            },
            "kind": "web",
            "properties": {
                "Application_Type": "web"
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces",
            "apiVersion": "2018-01-01-preview",
            "name": "[variables('ServiceBusName')]",
            "location": "[variables('IngestionClientRegion')]",
            "sku": {
                "name": "Standard",
                "tier": "Standard"
            },
            "properties": {
                "zoneRedundant": false
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces/AuthorizationRules",
            "apiVersion": "2017-04-01",
            "name": "[concat(variables('ServiceBusName'), '/RootManageSharedAccessKey')]",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('ServiceBusName'))]"
            ],
            "properties": {
                "rights": [
                    "Listen",
                    "Manage",
                    "Send"
                ]
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces/queues",
            "apiVersion": "2017-04-01",
            "name": "[concat(variables('ServiceBusName'), '/', variables('AudioUploadedQueueName'))]",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('ServiceBusName'))]"
            ],
            "properties": {
                "lockDuration": "PT4M",
                "maxSizeInMegabytes": 5120,
                "requiresDuplicateDetection": false,
                "requiresSession": false,
                "defaultMessageTimeToLive": "P10675199DT2H48M5.4775807S",
                "deadLetteringOnMessageExpiration": false,
                "enableBatchedOperations": false,
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "maxDeliveryCount": 1,
                "status": "Active",
                "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S",
                "enablePartitioning": false,
                "enableExpress": false
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces/queues/authorizationRules",
            "apiVersion": "2017-04-01",
            "name": "[concat(variables('ServiceBusName'), '/', variables('AudioUploadedQueueName'), '/', variables('AudioUploadedEventName'))]",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces/queues', variables('ServiceBusName'), variables('AudioUploadedQueueName'))]",
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('ServiceBusName'))]"
            ],
            "properties": {
                "rights": [
                    "Listen",
                    "Send"
                ]
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces/queues",
            "apiVersion": "2017-04-01",
            "name": "[concat(variables('ServiceBusName'), '/', variables('ResultUploadedQueueName'))]",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('ServiceBusName'))]"
            ],
            "properties": {
                "lockDuration": "PT4M",
                "maxSizeInMegabytes": 5120,
                "requiresDuplicateDetection": false,
                "requiresSession": false,
                "defaultMessageTimeToLive": "P10675199DT2H48M5.4775807S",
                "deadLetteringOnMessageExpiration": false,
                "enableBatchedOperations": false,
                "duplicateDetectionHistoryTimeWindow": "PT10M",
                "maxDeliveryCount": 1,
                "status": "Active",
                "autoDeleteOnIdle": "P10675199DT2H48M5.4775807S",
                "enablePartitioning": false,
                "enableExpress": false
            }
        },
        {
            "type": "Microsoft.ServiceBus/namespaces/queues/authorizationRules",
            "apiVersion": "2017-04-01",
            "name": "[concat(variables('ServiceBusName'), '/', variables('ResultUploadedQueueName'), '/', variables('ResultUploadedEventName'))]",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.ServiceBus/namespaces/queues', variables('ServiceBusName'), 'result_uploaded_queue')]",
                "[resourceId('Microsoft.ServiceBus/namespaces', variables('ServiceBusName'))]"
            ],
            "properties": {
                "rights": [
                    "Listen",
                    "Send"
                ]
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults",
            "name": "[variables('KeyVaultName')]",
            "apiVersion": "2019-09-01",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/sites', variables('IngestionClientAudioUploadedFunctionName'))]",
                "[resourceId('Microsoft.Web/sites', variables('IngestionClientResultUploadedFunctionName'))]"
            ],
            "properties": {
                "enabledForDeployment": "true",
                "enabledForDiskEncryption": "false",
                "enabledForTemplateDeployment": "false",
                "tenantId": "[subscription().tenantId]",
                "accessPolicies": [
                    {
                        "objectId": "[reference(resourceId('Microsoft.Web/sites', variables('IngestionClientAudioUploadedFunctionName')), '2019-08-01', 'full').identity.principalId]",
                        "tenantId": "[reference(resourceId('Microsoft.Web/sites', variables('IngestionClientAudioUploadedFunctionName')), '2019-08-01', 'full').identity.tenantId]",
                        "permissions": {
                            "secrets": [
                                "get",
                                "list"
                            ]
                        }
                    },
                    {
                        "objectId": "[reference(resourceId('Microsoft.Web/sites', variables('IngestionClientResultUploadedFunctionName')), '2019-08-01', 'full').identity.principalId]",
                        "tenantId": "[reference(resourceId('Microsoft.Web/sites', variables('IngestionClientResultUploadedFunctionName')), '2019-08-01', 'full').identity.tenantId]",
                        "permissions": {
                            "secrets": [
                                "get",
                                "list"
                            ]
                        }
                    }
                ],
                "sku": {
                    "name": "Standard",
                    "family": "A"
                },
                "networkAcls": {
                    "defaultAction": "Allow",
                    "bypass": "AzureServices"
                }
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "name": "[concat(variables('KeyVaultName'), '/', variables('CognitiveServicesKeySecretName'))]",
            "apiVersion": "2019-09-01",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[concat('Microsoft.KeyVault/vaults/', variables('KeyVaultName'))]",
                "[concat('Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesResourceName'))]"
            ],
            "properties": {
                "value": "[listKeys(concat(resourceGroup().id,'/providers/','Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesResourceName')), '2017-04-18').key1]"
            }
        },
        {
            "type": "Microsoft.KeyVault/vaults/secrets",
            "name": "[concat(variables('KeyVaultName'), '/', variables('CognitiveServicesFallbackKeySecretName'))]",
            "apiVersion": "2019-09-01",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[concat('Microsoft.KeyVault/vaults/', variables('KeyVaultName'))]",
                "[concat('Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesFallbackResourceName'))]"
            ],
            "properties": {
                "value": "[listKeys(concat(resourceGroup().id,'/providers/','Microsoft.CognitiveServices/accounts/', parameters('cognitiveServicesFallbackResourceName')), '2017-04-18').key1]"
            }
        },
        {
            "name": "[variables('EventGridSystemTopicName')]",
            "type": "Microsoft.EventGrid/systemTopics",
            "apiVersion": "2020-04-01-preview",
            "location": "[parameters('storageResourceRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]"
            ],
            "properties": {
                "source": "[resourceId('Microsoft.Storage/storageAccounts', parameters('storageResourceName'))]",
                "topicType": "Microsoft.Storage.StorageAccounts"
            }
        },
        {
            "type": "Microsoft.EventGrid/systemTopics/eventSubscriptions",
            "apiVersion": "2020-04-01-preview",
            "name": "[concat(variables('EventGridSystemTopicName'), '/', variables('AudioUploadedEventName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.EventGrid/systemTopics', variables('EventGridSystemTopicName'))]",
                "[resourceId('Microsoft.ServiceBus/namespaces/queues', variables('ServiceBusName'), variables('AudioUploadedQueueName'))]"
            ],
            "properties": {
                "destination": {
                    "endpointType": "ServiceBusQueue",
                    "properties": {
                        "resourceId": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.ServiceBus/namespaces/', variables('ServiceBusName'),'/queues/', variables('AudioUploadedQueueName'))]"
                    }
                },
                "filter": {
                    "includedEventTypes": [
                        "Microsoft.Storage.BlobCreated"
                    ],
                    "advancedFilters": [
                        {
                            "operatorType": "StringBeginsWith",
                            "key": "Subject",
                            "values": [
                                "[concat('/blobServices/default/containers/', variables('AudioInputContainer'), '/blobs')]"
                            ]
                        },
                        {
                            "operatorType": "StringContains",
                            "key": "data.api",
                            "values": [
                                "FlushWithClose",
                                "PutBlob",
                                "PutBlockList",
                                "CopyBlob"
                            ]
                        }
                    ]
                },
                "labels": [],
                "eventDeliverySchema": "EventGridSchema"
            }
        },
        {
            "type": "Microsoft.EventGrid/systemTopics/eventSubscriptions",
            "apiVersion": "2020-04-01-preview",
            "name": "[concat(variables('EventGridSystemTopicName'), '/', variables('ResultUploadedEventName'))]",
            "dependsOn": [
                "[resourceId('Microsoft.EventGrid/systemTopics', variables('EventGridSystemTopicName'))]",
                "[resourceId('Microsoft.ServiceBus/namespaces/queues', variables('ServiceBusName'), variables('ResultUploadedQueueName'))]"
            ],
            "properties": {
                "destination": {
                    "endpointType": "ServiceBusQueue",
                    "properties": {
                        "resourceId": "[concat('/subscriptions/',subscription().subscriptionId,'/resourceGroups/',resourceGroup().name,'/providers/Microsoft.ServiceBus/namespaces/', variables('ServiceBusName'),'/queues/', variables('ResultUploadedQueueName'))]"
                    }
                },
                "filter": {
                    "includedEventTypes": [
                        "Microsoft.Storage.BlobCreated"
                    ],
                    "advancedFilters": [
                        {
                            "operatorType": "StringBeginsWith",
                            "key": "Subject",
                            "values": [
                                "[concat('/blobServices/default/containers/', variables('SpeechServicesOutputContainer'), '/blobs')]"
                            ]
                        },
                        {
                            "operatorType": "StringContains",
                            "key": "data.api",
                            "values": [
                                "FlushWithClose",
                                "PutBlob",
                                "PutBlockList",
                                "CopyBlob"
                            ]
                        }
                    ]
                },
                "labels": [],
                "eventDeliverySchema": "EventGridSchema"
            }
        },
        {
            "apiVersion": "2018-02-01",
            "type": "Microsoft.Web/serverfarms",
            "kind": "app",
            "name": "[variables('AppServicePlanName')]",
            "location": "[variables('IngestionClientRegion')]",
            "properties": {},
            "dependsOn": [],
            "sku": {
                "name": "EP1"
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2020-09-01",
            "name": "[variables('IngestionClientAudioUploadedFunctionName')]",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('AppServicePlanName'))]"
            ],
            "kind": "functionapp",
            "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('AppServicePlanName'))]",
                "httpsOnly": "true",
                "siteConfig": {
                    "use32BitWorkerProcess": false
                }
            },
            "identity": {
                "type": "SystemAssigned"
            }
        },
        {
            "type": "Microsoft.Web/sites",
            "apiVersion": "2020-09-01",
            "name": "[variables('IngestionClientResultUploadedFunctionName')]",
            "location": "[variables('IngestionClientRegion')]",
            "dependsOn": [
                "[resourceId('Microsoft.Web/serverfarms', variables('AppServicePlanName'))]"
            ],
            "kind": "functionapp",
            "properties": {
                "serverFarmId": "[resourceId('Microsoft.Web/serverfarms', variables('AppServicePlanName'))]",
                "httpsOnly": "true",
                "siteConfig": {
                    "use32BitWorkerProcess": false
                }
            },
            "identity": {
                "type": "SystemAssigned"
            }
        }
    ]
}